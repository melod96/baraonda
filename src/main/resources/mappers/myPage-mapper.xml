<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <!--Dao에서 Member.query로 작성을 했을 때 앞의 Member가 여기서 mapper의 namespace이고 query부분은 query의 이름부분이다.-->
<mapper namespace="MyPage">

	<resultMap type="com.kh.baraonda.myPage.model.vo.Point" id="pointResultSet">
		<id property="point_no" column="POINT_NO"/>
		<result property="member_no" column="MEMBER_NO"/>
		<result property="point_change_date" column="POINT_CHANGE_DATE"/>
		<result property="accrue_point" column="ACCRUE_POINT"/>
	</resultMap>
	
	<resultMap type="com.kh.baraonda.myPage.model.vo.Files" id="filesResultSet">
		<id property="files_no" column="FILES_NO"/>
		<result property="f_reference_no" column="F_REFERENCE_NO"/>
		<result property="files_title" column="FILES_TITLE"/>
		<result property="files_change_title" column="FILES_CHANGE_TITLE"/>
		<result property="files_type" column="FILES_TYPE"/>
		<result property="files_root" column="FILES_ROOT"/>
		<result property="files_secession" column="FILES_SECESSION"/>
	</resultMap>
	
	<resultMap type="com.kh.baraonda.myPage.model.vo.Footprints" id="footprintsResultSet">
		<id property="board_count" column="BOARD_COUNT"/>
		<result property="comments_count" column="COMMENTS_COUNT"/>
		<result property="marking_count" column="MARKING_COUNT"/>
		<result property="accrue_point" column="ACCRUE_POINT"/>
		<result property="enroll_date" column="ENROLL_DATE"/>
	</resultMap>
	
	<resultMap type="com.kh.baraonda.board.model.vo.Board" id="boardResultSet">
		<id property="board_no" column="BOARD_NO"/>
		<result property="board_type" column="BOARD_TYPE" />
		<result property="writing_type" column="WRITING_TYPE" />
		<result property="board_title" column="BOARD_TITLE" />
		<result property="board_content" column="BOARD_CONTENT"/>
		<result property="member_no" column="MEMBER_NO" />
		<result property="board_date" column="BOARD_DATE" />
		<result property="modify_date" column="MODIFY_DATE" />
		<result property="board_status" column="BOARD_STATUS" />
		<result property="board_count" column="BOARD_COUNT" />
	</resultMap>
	
	<resultMap type="com.kh.baraonda.myPage.model.vo.Marking" id="markingResultSet">
		<id property="marking_no" column="MARKING_NO"/>
		<result property="marking_type" column="MARKING_TYPE" />
		<result property="marking_date" column="MARKING_DATE" />
		<result property="board_no" column="BOARD_NO" />
		<result property="member_no" column="MEMBER_NO"/>
		<result property="marking_count" column="MARKING_COUNT"/>
	</resultMap>
	
	<resultMap type="com.kh.baraonda.myPage.model.vo.Comments" id="commentsResultSet2">
		<id property="comments_no" column="COMMENTS_NO"/>
		<result property="comments_content" column="COMMENTS_CONTENT" />
		<result property="board_no" column="BOARD_NO" />
		<result property="member_no" column="MEMBER_NO" />
		<result property="comments_date" column="COMMENTS_DATE"/>
		<result property="comments_status" column="COMMENTS_STATUS"/>
		<result property="board_title" column="BOARD_TITLE"/>
		<result property="board_type" column="BOARD_TYPE"/>
	</resultMap>
	
	
	
	<select id="selectFootprints" resultMap="footprintsResultSet" parameterType="Footprints">
	
	SELECT BOARD_COUNT, COMMENTS_COUNT, MARKING_COUNT, ACCRUE_POINT, ENROLL_DATE
	
	FROM 
    	(SELECT  COUNT(BOARD_NO) BOARD_COUNT FROM BOARD 
	    WHERE MEMBER_NO = #{member_no} AND BOARD_STATUS = 0),
	    
  		(SELECT COUNT(COMMENTS_NO) COMMENTS_COUNT FROM COMMENTS
  		WHERE MEMBER_NO = #{member_no} AND COMMENTS_STATUS = 0),
  		
	    (SELECT COUNT(M.MARKING_NO) MARKING_COUNT FROM MARKING M
	  	JOIN BOARD B ON(M.BOARD_NO = B.BOARD_NO)
	    WHERE B.MEMBER_NO = #{member_no}),
	    
	    (SELECT ENROLL_DATE FROM MEMBER
	    WHERE MEMBER_NO = #{member_no}),
	    
	    (SELECT ACCRUE_POINT FROM POINT WHERE POINT_NO = ${member_no})
	</select>
	
	
	<select id="selectPoint" resultMap="pointResultSet" parameterType="Point">
		SELECT * FROM POINT
		WHERE POINT_NO = #{member_no}
	</select>
	
	<update id="updateMemberInfo" parameterType="_int">
		UPDATE MEMBER SET PASSWORD = '${password}', NICK_NAME = '${nick_name}' WHERE MEMBER_NO = ${member_no}
	</update>
	
	<insert id="insertPhoto" parameterType="Files">
		INSERT INTO FILES
		VALUES(
			SEQ_FILES_NO.NEXTVAL, #{f_reference_no},
			 #{files_title}, #{files_change_title}, 
			 #{files_type}, #{files_root}, 0
		)
	
	</insert>
	
	<select id="selectPhoto"  resultMap="filesResultSet" parameterType="Files">
		SELECT RANK, FILES_NO, F_REFERENCE_NO, FILES_TITLE, FILES_TYPE, FILES_ROOT, FILES_SECESSION, FILES_CHANGE_TITLE 
		FROM(
			SELECT RANK() OVER (ORDER BY FILES_NO DESC) AS RANK,
			FILES_NO, F_REFERENCE_NO, FILES_TITLE, FILES_TYPE, FILES_ROOT, FILES_SECESSION, FILES_CHANGE_TITLE 
			FROM FILES WHERE F_REFERENCE_NO = #{member_no} AND FILES_TYPE = 1 AND FILES_SECESSION = 0 
         ) WHERE RANK BETWEEN 1 AND 1
	
	</select>
	
	<select id="selectListCount" resultType="_int">
		SELECT COUNT(*)
		FROM BOARD
		WHERE BOARD_STATUS = '0' AND MEMBER_NO = #{member_no}
	</select>
	
	
	<!-- 게시글 목록 조회 -->
	<select id="selectBoardList" resultMap="boardResultSet">
		SELECT * FROM BOARD 
		WHERE BOARD_STATUS = '0' AND MEMBER_NO = #{member_no}
		ORDER BY BOARD_NO DESC
	</select>
	
	<!--추천 개수 조회-->
	<select id="selectLikeCount" resultMap="markingResultSet">
		SELECT COUNT(M.MARKING_NO) MARKING_COUNT, B.BOARD_NO FROM MARKING M
    	JOIN BOARD B ON(M.BOARD_NO = B.BOARD_NO)
  		WHERE B.MEMBER_NO = #{member_no} group by B.BOARD_NO
	</select>
	
	<select id="selectCommentsListCount" resultType="_int">
		SELECT COUNT(*)
		FROM COMMENTS
		WHERE COMMENTS_STATUS = '0' AND MEMBER_NO = #{member_no}
	</select>
	
	
	<!--댓글 목록 조회-->
	<select id="selectCommentList" resultMap="commentsResultSet2">
		SELECT C.COMMENTS_NO, C.COMMENTS_CONTENT, C.BOARD_NO, C.MEMBER_NO, C.COMMENTS_DATE, C.COMMENTS_STATUS
                ,B.BOARD_TITLE, B.BOARD_TYPE FROM COMMENTS C 
        JOIN BOARD B ON(C.BOARD_NO = B.BOARD_NO)
		WHERE C.COMMENTS_STATUS = '0' AND C.MEMBER_NO = #{member_no}
		ORDER BY COMMENTS_NO DESC
	</select>
	
</mapper>
























